<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>National Digital Inclusion Network – Hub Mapper</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- SheetJS (optional: XLSX/XLS parsing). CSV will work even if this fails. -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: #ffffff;
      --ink: #031366;
      --muted: #e5e5e5;
      --teal: #00a39e;
      --orange: #f55426;
      --yellow: #f7bf29;
      --magenta: #f529a6;
      --danger: #cf1c45;
      --radius: 14px;
      --shadow: 0 10px 24px rgba(3,19,102,.08);
      --shadow2: 0 12px 28px rgba(3,19,102,.10);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      background: #f7f8ff;
    }
    .wrap{ display:flex; height:100vh; width:100%; }

    /* Sidebar */
    .sidebar{
      width: 410px;
      background: var(--bg);
      border-right: 1px solid var(--muted);
      padding: 16px;
      overflow-y:auto;
    }

    .brand{
      display:flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 10px 14px;
      border-bottom: 1px solid var(--muted);
      margin-bottom: 14px;
    }
    .brand img{
      height: 38px;
      max-width: 240px;
      width: auto;
      display:block;
    }
    .brand .title{ display:flex; flex-direction:column; line-height:1.15; }
    .brand .title strong{ font-size: 18px; letter-spacing:.2px; line-height: 1.25; }
    .brand .title span{ font-size: 12px; color: rgba(3,19,102,.70); }

    .stage{
      position: relative;
      background: #fff;
      border: 1px solid var(--muted);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 14px 18px;
      margin-bottom: 12px;
      overflow:hidden;
    }
    .stage::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 6px;
      background: var(--teal);
    }
    .stage.stage2::before{ background: var(--orange); }
    .stage.stage3::before{ background: var(--yellow); }

    .sectionHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px; }
    h2{ font-size: 13px; margin:0; letter-spacing:.2px; }
    .badge{
      font-size: 11px; font-weight: 900;
      color: var(--ink);
      background: rgba(3,19,102,.06);
      border: 1px solid rgba(3,19,102,.10);
      padding: 3px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .statusPill{
      font-size: 11px;
      font-weight: 900;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(3,19,102,.12);
      background: rgba(3,19,102,.04);
      color: rgba(3,19,102,.85);
      white-space:nowrap;
    }
    .statusPill.ok{
      border-color: rgba(0,163,158,.30);
      background: rgba(0,163,158,.10);
      color: rgba(3,19,102,.95);
    }
    .statusPill.warn{
      border-color: rgba(245,84,38,.30);
      background: rgba(245,84,38,.10);
      color: rgba(3,19,102,.95);
    }
    .statusPill.bad{
      border-color: rgba(207,28,69,.30);
      background: rgba(207,28,69,.10);
      color: rgba(3,19,102,.95);
    }

    .hint{
      font-size: 12px;
      color: rgba(3,19,102,.72);
      margin-top: 6px;
      line-height: 1.35;
    }

    label{
      font-size: 12px;
      font-weight: 800;
      display:block;
      margin: 10px 0 6px;
    }
    input, textarea, select, button{ font-family: inherit; }
    input, textarea, select{
      width:100%;
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
      color: var(--ink);
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(0,163,158,.55);
      box-shadow: 0 0 0 4px rgba(0,163,158,.12);
    }
    input.invalid{
      border-color: rgba(207,28,69,.55);
      box-shadow: 0 0 0 4px rgba(207,28,69,.10);
    }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items:end; }

    .actions{ display:flex; gap:10px; margin-top: 12px; }
    .btn{
      border: 1px solid rgba(3,19,102,.16);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      touch-action: manipulation;
      transition: transform .02s ease, box-shadow .15s ease, opacity .15s ease;
      user-select:none;
      background:#fff;
      color: var(--ink);
    }
    .btnPrimary{
      background: var(--ink);
      color:#fff;
      border-color: var(--ink);
      flex: 1;
      box-shadow: 0 10px 18px rgba(3,19,102,.18);
    }
    .btnPrimary:active{ transform: translateY(1px); }
    .btnGhost{ background:#fff; color: var(--ink); }
    .btnSmall{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 900;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      padding: 6px;
      background: rgba(3,19,102,.04);
      border: 1px solid var(--muted);
      border-radius: 14px;
      margin-top: 6px;
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      font-weight: 900;
      font-size: 12px;
      color: rgba(3,19,102,.80);
      cursor:pointer;
    }
    .tab.active{
      background:#fff;
      border-color: rgba(3,19,102,.14);
      color: var(--ink);
      box-shadow: 0 8px 18px rgba(3,19,102,.08);
    }

    /* Upload */
    .dropzone{
      border: 1.5px dashed rgba(3,19,102,.25);
      border-radius: 14px;
      padding: 12px;
      background: rgba(0,163,158,.06);
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin-top: 10px;
    }
    .dropzone.dragover{
      border-color: var(--teal);
      background: rgba(0,163,158,.12);
      box-shadow: 0 0 0 4px rgba(0,163,158,.12) inset;
    }
    .dzTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .dzTop strong{ font-size: 13px; }
    .dzTop .small{ font-size: 12px; color: rgba(3,19,102,.70); }
    .fileBtn{
      display:inline-block;
      padding: 8px 10px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid rgba(3,19,102,.16);
      font-weight: 900;
      cursor:pointer;
      white-space:nowrap;
    }
    .uploadStatus{
      font-size: 12px;
      font-weight: 900;
      color: rgba(3,19,102,.80);
    }
    .fileInput{
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      opacity: 0.01;
    }

    /* Preview / Validation */
    .panel{
      margin-top: 10px;
      border: 1px solid var(--muted);
      border-radius: 14px;
      background: #fff;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .panelTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      background: rgba(3,19,102,.04);
      border-bottom: 1px solid var(--muted);
    }
    .panelTop strong{ font-size: 12px; font-weight: 900; }
    .panelBody{ padding: 10px 12px; }
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 10px;
      font-size: 12px;
      color: rgba(3,19,102,.78);
      line-height: 1.3;
    }
    .kv b{ color: rgba(3,19,102,.95); }
    .previewTable{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    .previewTable th, .previewTable td{
      padding: 8px 8px;
      border-top: 1px solid var(--muted);
      text-align:left;
      vertical-align: top;
    }
    .previewTable th{
      color: rgba(3,19,102,.70);
      font-weight: 900;
      background: rgba(3,19,102,.02);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    details.errList{
      margin-top: 10px;
      border-top: 1px solid var(--muted);
      padding-top: 10px;
    }
    details.errList summary{
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
      color: rgba(3,19,102,.88);
    }
    .errItems{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(3,19,102,.78);
      line-height: 1.35;
      max-height: 160px;
      overflow:auto;
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 8px;
      background: rgba(3,19,102,.02);
    }
    .errItems .bad{ color: var(--danger); font-weight: 900; }

    /* Manual entry table */
    .manualWrap{
      margin-top: 10px;
      border: 1px solid var(--muted);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow);
    }
    .manualHead{
      display:grid;
      grid-template-columns: 42px 1fr 140px 44px;
      padding: 10px 12px;
      background: rgba(3,19,102,.04);
      border-bottom: 1px solid var(--muted);
      font-size: 12px;
      font-weight: 900;
      color: rgba(3,19,102,.78);
    }
    .manualGridRow{
      display:grid;
      grid-template-columns: 42px 1fr 140px 44px;
      border-bottom: 1px solid var(--muted);
      align-items:center;
    }
    .manualGridRow:last-child{ border-bottom:0; }
    .cell{
      padding: 8px 10px;
      font-size: 12px;
      color: rgba(3,19,102,.80);
    }
    .cellNum{ text-align:center; font-weight: 900; color: rgba(3,19,102,.55); }
    .cell input{
      width:100%;
      border: 1px solid rgba(3,19,102,.10);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 13px;
    }
    .cellBtn{
      display:flex;
      justify-content:center;
    }
    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(3,19,102,.14);
      background: #fff;
      cursor:pointer;
      font-weight: 900;
      color: rgba(3,19,102,.70);
    }
    .iconBtn:hover{ box-shadow: 0 8px 16px rgba(3,19,102,.10); }

    /* Map */
    #map{ flex: 1; height: 100vh; }

    /* Leaflet legend */
    .legend{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(3,19,102,.12);
      border-radius: 14px;
      box-shadow: var(--shadow2);
      padding: 10px 10px;
      color: var(--ink);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      font-size: 12px;
      line-height: 1.35;
      min-width: 180px;
    }
    .legendTitle{
      font-weight: 900;
      margin-bottom: 6px;
      letter-spacing: .2px;
      font-size: 12px;
    }
    .legendRow{
      display:flex;
      align-items:center;
      gap:8px;
      margin: 6px 0;
    }
    .legendDot{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: var(--ink);
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.18);
      flex: 0 0 auto;
    }
    .legendRing{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid var(--teal);
      background: transparent;
      flex: 0 0 auto;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .stat{
      border:1px solid var(--muted);
      border-radius: 14px;
      padding: 10px 10px;
      background: #fff;
      box-shadow: var(--shadow);
    }
    .stat .k{ font-size: 11px; color: rgba(3,19,102,.70); font-weight: 900; }
    .stat .v{ font-size: 16px; font-weight: 1000; margin-top: 4px; }

    .error{
      margin-top: 10px;
      font-size: 12px;
      color: var(--danger);
      white-space: pre-wrap;
      font-weight: 800;
    }

    @media (max-width: 900px){
      .wrap{ flex-direction: column; }
      .sidebar{ width: 100%; border-right:none; border-bottom: 1px solid var(--muted); }
      #map{ height: 60vh; }
      .manualHead, .manualGridRow{ grid-template-columns: 36px 1fr 120px 40px; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <aside class="sidebar">
    <div class="brand">
      <img src="./gtf-logo-full.png" alt="Good Things Foundation logo">
      <div class="title">
        <strong>National Digital Inclusion Network Mapping</strong>
        <span>Postcode-based hub visualiser</span>
      </div>
    </div>

    <!-- Stage 1 -->
    <section class="stage stage1">
      <div class="sectionHeader">
        <h2>Stage 1 — Central location</h2>
        <span class="badge">1</span>
      </div>

      <label for="centre">Central postcode</label>
      <input id="centre" placeholder="e.g. E1 6AN" autocapitalize="characters">

      <label for="centreName">Centre name (optional)</label>
      <input id="centreName" placeholder="e.g. Birmingham City Centre">

      <div class="hint">We’ll use this as the anchor point for the radius ring and distance calculations.</div>
    </section>

    <!-- Stage 2 -->
    <section class="stage stage2">
      <div class="sectionHeader">
        <h2>Stage 2 — Hubs to map</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <span id="dataStatus" class="statusPill warn">No hubs loaded</span>
          <span class="badge">2</span>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Hub input method">
        <button id="tabBulk" class="tab active" type="button" role="tab" aria-selected="true">Bulk Upload</button>
        <button id="tabManual" class="tab" type="button" role="tab" aria-selected="false">Manual Input</button>
      </div>

      <!-- Bulk panel -->
      <div id="panelBulk">
        <div id="dropzone" class="dropzone">
          <div class="dzTop">
            <div>
              <strong>Upload a file</strong>
              <div class="small">CSV recommended · XLSX supported (if library loads)</div>
            </div>
            <button id="chooseFileBtn" class="fileBtn" type="button">Choose file</button>
            <input id="fileInput" class="fileInput" type="file"
              accept=".xlsx,.xls,.csv,.tsv,.txt,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv,text/tab-separated-values">
          </div>

          <div class="hint">
            Format required: <strong>two columns, no headers</strong><br>
            Column A = <strong>Hub Name</strong>, Column B = <strong>Postcode</strong>
          </div>

          <div class="actions" style="margin-top:8px;">
            <button id="templateBtn" class="btn btnSmall" type="button">Download CSV template</button>
            <button id="clearUploadBtn" class="btn btnSmall" type="button">Clear upload</button>
          </div>

          <div class="uploadStatus" id="uploadStatus">No file loaded yet.</div>
        </div>

        <div id="uploadPreview" class="panel" style="display:none;">
          <div class="panelTop">
            <strong>Upload preview</strong>
            <span id="uploadPill" class="statusPill warn">Needs attention</span>
          </div>
          <div class="panelBody">
            <div class="kv">
              <div>Rows read</div><div><b id="rowsRead">0</b></div>
              <div>Valid hubs</div><div><b id="validCount">0</b></div>
              <div>Invalid rows</div><div><b id="invalidCount">0</b></div>
            </div>

            <table class="previewTable" id="previewTable">
              <thead>
                <tr>
                  <th style="width:55%;">Hub name</th>
                  <th class="mono">Postcode</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <details class="errList" id="invalidDetails" style="display:none;">
              <summary>Show invalid rows</summary>
              <div class="errItems" id="invalidItems"></div>
            </details>

            <div class="hint">
              If rows are wrong-way-round, we’ll ask before swapping columns.
            </div>
          </div>
        </div>
      </div>

      <!-- Manual panel -->
      <div id="panelManual" style="display:none;">
        <div class="hint">
          Add hubs manually below. You can add more rows — but bulk upload is best if you have lots.
        </div>

        <div class="manualWrap">
          <div class="manualHead">
            <div>#</div>
            <div>Hub name</div>
            <div>Postcode</div>
            <div></div>
          </div>
          <div id="manualRows"></div>
        </div>

        <div class="actions" style="margin-top:10px;">
          <button id="addRowBtn" class="btn btnSmall" type="button">Add row</button>
          <button id="clearManualBtn" class="btn btnSmall" type="button">Clear manual</button>
        </div>

        <div id="manualPreview" class="panel" style="margin-top:10px;">
          <div class="panelTop">
            <strong>Manual validation</strong>
            <span id="manualPill" class="statusPill warn">Not ready</span>
          </div>
          <div class="panelBody">
            <div class="kv">
              <div>Rows filled</div><div><b id="manualFilled">0</b></div>
              <div>Valid hubs</div><div><b id="manualValid">0</b></div>
              <div>Invalid postcodes</div><div><b id="manualInvalid">0</b></div>
            </div>
            <details class="errList" id="manualInvalidDetails" style="display:none;">
              <summary>Show invalid entries</summary>
              <div class="errItems" id="manualInvalidItems"></div>
            </details>
          </div>
        </div>
      </div>
    </section>

    <!-- Stage 3 -->
    <section class="stage stage3">
      <div class="sectionHeader">
        <h2>Stage 3 — Parameters</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <span id="readyStatus" class="statusPill warn">Not ready</span>
          <span class="badge">3</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="radius">Radius (km)</label>
          <input id="radius" type="number" value="5" step="0.1" min="0.1">
        </div>

        <div>
          <label for="ringPreset">Ring colour</label>
          <select id="ringPreset">
            <option value="#00a39e" selected>Teal</option>
            <option value="#f55426">Orange</option>
            <option value="#031366">Ink</option>
            <option value="#f529a6">Magenta</option>
            <option value="#f7bf29">Yellow</option>
            <option value="custom">Custom…</option>
          </select>
        </div>
      </div>

      <div id="customColorWrap" style="display:none; margin-top:10px;">
        <label for="ringColor">Custom colour</label>
        <input id="ringColor" type="color" value="#00a39e" style="padding:6px; height:42px;">
      </div>

      <div class="actions">
        <button id="runBtn" class="btn btnPrimary" type="button" disabled>Map hubs</button>
        <button id="clearAllBtn" class="btn btnGhost" type="button">Clear</button>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button id="fitRingBtn" class="btn btnSmall" type="button">Fit radius</button>
        <button id="fitAllBtn" class="btn btnSmall" type="button">Fit all hubs</button>
        <button id="resetViewBtn" class="btn btnSmall" type="button">Reset view</button>
      </div>

      <div class="stats">
        <div class="stat"><div class="k">Inside radius</div><div class="v" id="inCount">0</div></div>
        <div class="stat"><div class="k">Outside radius</div><div class="v" id="outCount">0</div></div>
        <div class="stat"><div class="k">Mapped</div><div class="v" id="totalCount">0</div></div>
      </div>

      <div class="error" id="err"></div>
      <div class="hint">Geocoding uses postcodes.io. If some rows don’t map, we’ll list them clearly.</div>
    </section>

    <div class="hint" style="padding: 0 4px 10px;">
      Basemap: CARTO Positron · Hosted via GitHub Pages
    </div>
  </aside>

  <div id="map"></div>
</div>

<script>
  // =========================
  // Utilities
  // =========================
  const $ = (id) => document.getElementById(id);

  function setError(msg){ $("err").textContent = msg || ""; }
  function setCounts(i,o,t){
    $("inCount").textContent = i;
    $("outCount").textContent = o;
    $("totalCount").textContent = t;
  }
  function pill(el, kind, text){
    el.classList.remove("ok","warn","bad");
    el.classList.add(kind);
    el.textContent = text;
  }
  function norm(pc){ return (pc || "").trim().toUpperCase().replace(/\s+/g, ""); }
  function formatPostcode(pc){
    const n = norm(pc);
    if (n.length <= 3) return n;
    return n.slice(0, n.length - 3) + " " + n.slice(-3);
  }

  // UK postcode heuristic (simple but practical for validation)
  const POSTCODE_RE = /^([A-Z]{1,2}\d[A-Z\d]?)(\d[A-Z]{2})$/;
  function looksLikePostcode(s){
    const n = norm(s);
    return !!n && POSTCODE_RE.test(n);
  }

  // =========================
  // Map setup
  // =========================
  const map = L.map("map").setView([51.5074, -0.1278], 11);
  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}" + (L.Browser.retina ? "@2x.png" : ".png"),
    {
      subdomains: "abcd",
      maxZoom: 20,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
        '&copy; <a href="https://carto.com/attributions">CARTO</a>'
    }
  ).addTo(map);

  const layerGroup = L.layerGroup().addTo(map);
  let radiusCircle = null;
  let radiusGlow = null;
  let legendControl = null;

  // Keep last computed bounds for “fit” controls
  let lastRingBounds = null;
  let lastAllBounds = null;

  const HUB_ICON = L.icon({
    iconUrl: "./gtf-logo.png",
    iconSize: [22, 22],
    iconAnchor: [11, 11],
    popupAnchor: [0, -10]
  });

  // =========================
  // State machine (trust UX)
  // =========================
  // hubState: empty | loaded | ready
  let hubState = "empty";
  let hubMode = "bulk"; // bulk | manual

  // bulk data store:
  // {
  //   fileName, rowsRead, validHubs:[{name, postcode}], invalidRows:[{row, name, postcode, reason}],
  //   swapped:boolean
  // }
  let uploadData = null;

  function setHubState(state){
    hubState = state;

    if (state === "empty"){
      pill($("dataStatus"), "warn", "No hubs loaded");
    } else if (state === "loaded"){
      pill($("dataStatus"), "warn", "Loaded · needs review");
    } else {
      pill($("dataStatus"), "ok", "Ready");
    }
    refreshReadiness();
  }

  function isCentreValid(){
    const centrePc = norm($("centre").value);
    return !!centrePc;
  }

  function refreshReadiness(){
    const centreOk = isCentreValid();
    const radiusKm = Number($("radius").value);
    const radiusOk = Number.isFinite(radiusKm) && radiusKm > 0;

    const hubsOk =
      (hubMode === "bulk" && uploadData && uploadData.validHubs && uploadData.validHubs.length > 0 && hubState === "ready") ||
      (hubMode === "manual" && hubState === "ready");

    const ready = centreOk && radiusOk && hubsOk;

    pill($("readyStatus"), ready ? "ok" : "warn", ready ? "Ready to map" : "Not ready");
    $("runBtn").disabled = !ready;
  }

  // =========================
  // Ring colour
  // =========================
  const ringPreset = $("ringPreset");
  const customColorWrap = $("customColorWrap");
  const ringColorInput = $("ringColor");

  function getRingColor(){
    const preset = ringPreset.value;
    if (preset === "custom") return ringColorInput.value || "#00a39e";
    return preset || "#00a39e";
  }

  ringPreset.addEventListener("change", () => {
    const isCustom = ringPreset.value === "custom";
    customColorWrap.style.display = isCustom ? "block" : "none";
    if (!isCustom) ringColorInput.value = ringPreset.value;
  });

  // =========================
  // Legend
  // =========================
  function addLegend(ringColor){
    if (legendControl) { map.removeControl(legendControl); legendControl = null; }

    legendControl = L.control({ position: "bottomright" });
    legendControl.onAdd = function(){
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div class="legendTitle">Legend</div>
        <div class="legendRow"><span class="legendDot"></span><span>Centre</span></div>
        <div class="legendRow">
          <img src="./gtf-logo.png" alt="" style="width:16px;height:16px;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,.15);">
          <span>Hub</span>
        </div>
        <div class="legendRow"><span class="legendRing" style="border-color:${ringColor}"></span><span>Radius ring</span></div>
      `;
      L.DomEvent.disableClickPropagation(div);
      L.DomEvent.disableScrollPropagation(div);
      return div;
    };
    legendControl.addTo(map);
  }

  // =========================
  // Tabs
  // =========================
  function setMode(mode){
    hubMode = mode;
    if (mode === "bulk"){
      $("tabBulk").classList.add("active");
      $("tabManual").classList.remove("active");
      $("tabBulk").setAttribute("aria-selected", "true");
      $("tabManual").setAttribute("aria-selected", "false");
      $("panelBulk").style.display = "block";
      $("panelManual").style.display = "none";

      // bulk readiness depends on uploadData
      if (!uploadData || !uploadData.validHubs?.length){
        setHubState("empty");
      } else {
        // if they’ve reviewed / fixed, keep ready; else loaded
        setHubState(uploadData.invalidRows?.length ? "loaded" : "ready");
      }
    } else {
      $("tabManual").classList.add("active");
      $("tabBulk").classList.remove("active");
      $("tabManual").setAttribute("aria-selected", "true");
      $("tabBulk").setAttribute("aria-selected", "false");
      $("panelManual").style.display = "block";
      $("panelBulk").style.display = "none";

      validateManual(); // updates state
    }
    setError("");
    refreshReadiness();
  }

  $("tabBulk").addEventListener("click", () => setMode("bulk"));
  $("tabManual").addEventListener("click", () => setMode("manual"));

  // =========================
  // Manual table UX
  // =========================
  const manualRowsEl = $("manualRows");

  function makeManualRow(idx){
    const row = document.createElement("div");
    row.className = "manualGridRow";
    row.dataset.row = String(idx);

    const cNum = document.createElement("div");
    cNum.className = "cell cellNum";
    cNum.textContent = String(idx);

    const cName = document.createElement("div");
    cName.className = "cell";
    const nameInput = document.createElement("input");
    nameInput.placeholder = "Hub name";
    nameInput.addEventListener("input", debounce(validateManual, 150));
    cName.appendChild(nameInput);

    const cPc = document.createElement("div");
    cPc.className = "cell";
    const pcInput = document.createElement("input");
    pcInput.placeholder = "Postcode";
    pcInput.autocapitalize = "characters";
    pcInput.addEventListener("blur", () => { pcInput.value = formatPostcode(pcInput.value); validateManual(); });
    pcInput.addEventListener("input", debounce(validateManual, 150));
    cPc.appendChild(pcInput);

    const cDel = document.createElement("div");
    cDel.className = "cell cellBtn";
    const delBtn = document.createElement("button");
    delBtn.className = "iconBtn";
    delBtn.type = "button";
    delBtn.title = "Delete row";
    delBtn.textContent = "×";
    delBtn.addEventListener("click", () => {
      row.remove();
      renumberManual();
      validateManual();
    });
    cDel.appendChild(delBtn);

    row.appendChild(cNum);
    row.appendChild(cName);
    row.appendChild(cPc);
    row.appendChild(cDel);
    return row;
  }

  function renumberManual(){
    const rows = Array.from(manualRowsEl.querySelectorAll(".manualGridRow"));
    rows.forEach((r, i) => {
      r.dataset.row = String(i+1);
      r.querySelector(".cellNum").textContent = String(i+1);
    });
  }

  function addManualRow(){
    const nextIdx = manualRowsEl.querySelectorAll(".manualGridRow").length + 1;
    manualRowsEl.appendChild(makeManualRow(nextIdx));
    renumberManual();
  }

  // initial 10
  for (let i=0; i<10; i++) addManualRow();

  $("addRowBtn").addEventListener("click", () => addManualRow());
  $("clearManualBtn").addEventListener("click", () => {
    manualRowsEl.innerHTML = "";
    for (let i=0; i<10; i++) addManualRow();
    validateManual();
  });

  function getManualHubs(){
    const rows = Array.from(manualRowsEl.querySelectorAll(".manualGridRow"));
    const hubs = [];
    rows.forEach((r) => {
      const inputs = r.querySelectorAll("input");
      const name = (inputs[0]?.value || "").trim();
      const pcRaw = (inputs[1]?.value || "").trim();
      const postcode = norm(pcRaw);
      if (!name && !postcode) return; // skip blank rows
      hubs.push({ name: name || "Hub", postcode, row: r.dataset.row, _pcInput: inputs[1] });
    });
    return hubs;
  }

  function validateManual(){
    if (hubMode !== "manual") return;

    const hubs = getManualHubs();
    let filled = hubs.length;
    let valid = 0;
    let invalid = 0;
    const badList = [];

    // clear invalid styling first
    hubs.forEach(h => h._pcInput?.classList.remove("invalid"));

    hubs.forEach(h => {
      if (!h.postcode || !looksLikePostcode(h.postcode)){
        invalid++;
        badList.push(`Row ${h.row}: invalid postcode (“${h.postcode || ""}”)`);
        h._pcInput?.classList.add("invalid");
      } else {
        valid++;
      }
    });

    $("manualFilled").textContent = String(filled);
    $("manualValid").textContent = String(valid);
    $("manualInvalid").textContent = String(invalid);

    const det = $("manualInvalidDetails");
    const items = $("manualInvalidItems");
    if (badList.length){
      det.style.display = "block";
      items.innerHTML = badList.map(x => `<div class="bad">${escapeHtml(x)}</div>`).join("");
      pill($("manualPill"), "bad", "Fix issues");
      setHubState("loaded");
    } else if (valid > 0){
      det.style.display = "none";
      items.innerHTML = "";
      pill($("manualPill"), "ok", "Ready");
      setHubState("ready");
    } else {
      det.style.display = "none";
      items.innerHTML = "";
      pill($("manualPill"), "warn", "Add hubs");
      setHubState("empty");
    }

    refreshReadiness();
  }

  // =========================
  // Upload UX + preview + validation
  // =========================
  const dropzone = $("dropzone");
  const fileInput = $("fileInput");
  const chooseFileBtn = $("chooseFileBtn");
  const uploadStatus = $("uploadStatus");

  chooseFileBtn.addEventListener("click", () => fileInput.click());

  $("templateBtn").addEventListener("click", () => {
    const csv = `Hub name,Postcode\nExample Hub,SW1A 1AA\n`;
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ndin-hubs-template.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("clearUploadBtn").addEventListener("click", () => {
    uploadData = null;
    uploadStatus.textContent = "No file loaded yet.";
    $("uploadPreview").style.display = "none";
    setHubState("empty");
  });

  ["dragenter","dragover"].forEach(evt => {
    dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      dropzone.classList.add("dragover");
    });
  });
  ["dragleave","drop"].forEach(evt => {
    dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      dropzone.classList.remove("dragover");
    });
  });
  dropzone.addEventListener("drop", async (e) => {
    const file = e.dataTransfer?.files?.[0];
    if (file) await handleUploadFile(file);
  });

  fileInput.addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (f) await handleUploadFile(f);
    fileInput.value = "";
  });

  // CSV parser (robust enough for simple exports)
  function parseCSV(text){
    const rows = [];
    let row = [], cur = "", inQuotes = false;
    for (let i=0; i<text.length; i++){
      const ch = text[i];
      const next = text[i+1];
      if (ch === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === "," && !inQuotes){
        row.push(cur); cur = "";
      } else if ((ch === "\n" || ch === "\r") && !inQuotes){
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); rows.push(row);
        row = []; cur = "";
      } else {
        cur += ch;
      }
    }
    if (cur.length || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  function normaliseRowsToTwoCols(rows){
    const cleaned = [];
    for (const r of rows){
      const a = (r?.[0] ?? "").toString().trim();
      const b = (r?.[1] ?? "").toString().trim();
      const c = (r?.[2] ?? "").toString().trim();
      // If there are 3+ cols and col3 isn't empty, flag later in preview messaging via rowsRead only; still proceed using first 2 cols.
      if (!a && !b) continue;
      cleaned.push([a,b,c]);
    }
    return cleaned;
  }

  function assessSwap(twoCols){
    let expected = 0;
    let swapped = 0;
    for (const [a,b] of twoCols){
      const aIsPC = looksLikePostcode(a);
      const bIsPC = looksLikePostcode(b);
      if (bIsPC && !aIsPC) expected++;
      else if (aIsPC && !bIsPC) swapped++;
    }
    return { expected, swapped };
  }

  function renderUploadPreview(data){
    $("uploadPreview").style.display = "block";
    $("rowsRead").textContent = String(data.rowsRead);
    $("validCount").textContent = String(data.validHubs.length);
    $("invalidCount").textContent = String(data.invalidRows.length);

    // pill
    if (data.validHubs.length > 0 && data.invalidRows.length === 0){
      pill($("uploadPill"), "ok", "Ready");
    } else if (data.validHubs.length > 0){
      pill($("uploadPill"), "warn", "Review");
    } else {
      pill($("uploadPill"), "bad", "Not usable");
    }

    // table preview (first 6 valid)
    const tb = $("previewTable").querySelector("tbody");
    tb.innerHTML = "";
    data.validHubs.slice(0,6).forEach(h => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(h.name)}</td><td class="mono">${escapeHtml(formatPostcode(h.postcode))}</td>`;
      tb.appendChild(tr);
    });
    if (data.validHubs.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="2" style="color:rgba(3,19,102,.70); font-weight:900;">No valid hubs detected yet.</td>`;
      tb.appendChild(tr);
    }

    // invalid list
    if (data.invalidRows.length){
      $("invalidDetails").style.display = "block";
      const items = data.invalidRows
        .slice(0,200)
        .map(x => `<div class="bad">Row ${x.row}: ${escapeHtml(x.reason)} (A="${escapeHtml(x.nameRaw)}", B="${escapeHtml(x.postcodeRaw)}")</div>`)
        .join("");
      $("invalidItems").innerHTML = items;
    } else {
      $("invalidDetails").style.display = "none";
      $("invalidItems").innerHTML = "";
    }
  }

  async function handleUploadFile(file){
    setError("");
    uploadData = null;
    uploadStatus.textContent = "Loading…";

    try{
      const lower = (file.name || "").toLowerCase();
      const isCSV = lower.endsWith(".csv") || file.type.includes("csv") || file.type === "text/plain";

      let rows;
      if (isCSV){
        const text = await file.text();
        rows = parseCSV(text);
      } else {
        if (typeof XLSX === "undefined"){
          throw new Error("Spreadsheet library didn’t load (XLSX is not defined). CSV uploads will work; for XLSX, refresh the page or stick to CSV.");
        }
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: "array" });
        const sheetName = wb.SheetNames?.[0];
        if (!sheetName) throw new Error("No sheet found in that spreadsheet.");
        const ws = wb.Sheets[sheetName];
        rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false, defval: "" });
      }

      const raw = normaliseRowsToTwoCols(rows);
      if (!raw.length) throw new Error("No usable rows found. Put data in the first two columns.");

      // detect header-ish (best effort)
      const firstA = (raw[0][0] || "").toString().toLowerCase();
      const firstB = (raw[0][1] || "").toString().toLowerCase();
      const headerish = (firstA.includes("hub") || firstA.includes("name") || firstA.includes("organisation")) &&
                        (firstB.includes("post") || firstB.includes("zip") || firstB.includes("code"));
      if (headerish){
        const ok = window.confirm(
          `Your first row looks like a header.\n\nThis tool expects NO headers.\n\nOK = Continue anyway\nCancel = Stop`
        );
        if (!ok) throw new Error("Upload cancelled (header row detected).");
      }

      // build 2-col view
      let twoCols = raw.map(r => [r[0], r[1]]);

      // swapped detection + confirm
      const { expected, swapped } = assessSwap(twoCols);
      let didSwap = false;
      if (swapped > 0 && swapped >= expected * 1.5){
        const ok = window.confirm(
          `Your file looks like the columns may be the wrong way around.\n\n` +
          `Expected: Column A = Hub Name, Column B = Postcode\n\n` +
          `OK = Continue (we will swap columns A/B)\nCancel = Stop`
        );
        if (!ok) throw new Error("Upload cancelled.");
        twoCols = twoCols.map(([a,b]) => [b,a]);
        didSwap = true;
      }

      // validate rows -> hubs + invalid list
      const validHubs = [];
      const invalidRows = [];
      twoCols.forEach((r, i) => {
        const nameRaw = (r[0] ?? "").toString().trim();
        const postcodeRaw = (r[1] ?? "").toString().trim();
        const pc = norm(postcodeRaw);

        if (!nameRaw && !pc) return; // skip blank row

        if (!pc || !looksLikePostcode(pc)){
          invalidRows.push({
            row: i+1,
            nameRaw,
            postcodeRaw,
            reason: "Invalid postcode"
          });
        } else {
          validHubs.push({
            name: nameRaw || "Hub",
            postcode: pc
          });
        }
      });

      uploadData = {
        fileName: file.name,
        rowsRead: twoCols.length,
        validHubs,
        invalidRows,
        swapped: didSwap
      };

      uploadStatus.textContent =
        `Loaded "${file.name}": ${validHubs.length} valid hub(s)` +
        (invalidRows.length ? ` · ${invalidRows.length} invalid row(s)` : "") +
        (didSwap ? " · columns swapped" : "") +
        ".";

      renderUploadPreview(uploadData);

      // update state
      if (validHubs.length === 0){
        setHubState("loaded");
        pill($("uploadPill"), "bad", "Not usable");
      } else if (invalidRows.length){
        setHubState("loaded"); // loaded but needs review
      } else {
        setHubState("ready");
      }

      // stay in bulk mode
      setMode("bulk");
    } catch (e){
      uploadData = null;
      uploadStatus.textContent = "No file loaded yet.";
      $("uploadPreview").style.display = "none";
      setHubState("empty");
      setError(e?.message || String(e));
    }
  }

  // =========================
  // Geocoding (ORDER-PRESERVING)
  // =========================
  async function geocodeSingle(pc) {
    const r = await fetch("https://api.postcodes.io/postcodes/" + encodeURIComponent(pc));
    const j = await r.json();
    if (!j.result) throw new Error("Invalid centre postcode");
    return j.result;
  }

  // IMPORTANT: do NOT filter out failures; keep order
  async function geocodeBulkOrdered(postcodes) {
    const r = await fetch("https://api.postcodes.io/postcodes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ postcodes })
    });
    const j = await r.json();
    if (!j.result) throw new Error("Bulk lookup failed");
    // Each item: {query, result}
    return j.result;
  }

  // =========================
  // Mapping
  // =========================
  function clearMapOnly(){
    layerGroup.clearLayers();
    if (radiusCircle) { map.removeLayer(radiusCircle); radiusCircle = null; }
    if (radiusGlow) { map.removeLayer(radiusGlow); radiusGlow = null; }
    if (legendControl) { map.removeControl(legendControl); legendControl = null; }
    lastRingBounds = null;
    lastAllBounds = null;
    setCounts(0,0,0);
  }

  function distanceKm(aLat, aLon, bLat, bLon) {
    const R = 6371;
    const dLat = (bLat - aLat) * Math.PI / 180;
    const dLon = (bLon - aLon) * Math.PI / 180;
    const lat1 = aLat * Math.PI / 180;
    const lat2 = bLat * Math.PI / 180;
    const h =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
    return 2 * R * Math.asin(Math.sqrt(h));
  }

  $("runBtn").addEventListener("click", run);
  $("clearAllBtn").addEventListener("click", () => {
    setError("");
    $("centre").value = "";
    $("centreName").value = "";
    $("radius").value = "5";
    clearMapOnly();
    uploadData = null;
    uploadStatus.textContent = "No file loaded yet.";
    $("uploadPreview").style.display = "none";
    setHubState("empty");
    // reset manual
    manualRowsEl.innerHTML = "";
    for (let i=0; i<10; i++) addManualRow();
    validateManual();
    setMode("bulk");
  });

  $("fitRingBtn").addEventListener("click", () => {
    if (lastRingBounds) map.fitBounds(lastRingBounds, { padding: [30,30] });
  });
  $("fitAllBtn").addEventListener("click", () => {
    if (lastAllBounds) map.fitBounds(lastAllBounds, { padding: [30,30] });
  });
  $("resetViewBtn").addEventListener("click", () => {
    map.setView([54.5, -3.2], 6); // UK-ish view
  });

  async function run(){
    setError("");
    $("runBtn").disabled = true;

    clearMapOnly();

    try{
      const centrePc = norm($("centre").value);
      const centreName = ($("centreName").value || "").trim() || "Centre";
      const radiusKm = Number($("radius").value);
      const ringColor = getRingColor();

      if (!centrePc) throw new Error("Enter a central postcode.");
      if (!Number.isFinite(radiusKm) || radiusKm <= 0) throw new Error("Radius must be a positive number (km).");

      // hubs source
      let hubs;
      if (hubMode === "bulk"){
        if (!uploadData || !uploadData.validHubs?.length) throw new Error("Upload hubs first.");
        if (hubState !== "ready" && uploadData.invalidRows?.length){
          // not hard-blocking, but we warn: next level trust UX
          const ok = window.confirm(
            `Your upload contains invalid rows.\n\n` +
            `OK = Map only the valid hubs (${uploadData.validHubs.length})\nCancel = Go back and fix`
          );
          if (!ok) throw new Error("Mapping cancelled.");
        }
        hubs = uploadData.validHubs;
      } else {
        const manual = getManualHubs().filter(h => h.postcode);
        const invalid = manual.filter(h => !looksLikePostcode(h.postcode));
        if (invalid.length) throw new Error("Fix invalid postcodes in manual entry before mapping.");
        hubs = manual.map(h => ({ name: h.name, postcode: h.postcode }));
      }

      const centre = await geocodeSingle(centrePc);
      const cLatLng = [centre.latitude, centre.longitude];

      // Centre marker
      L.marker(cLatLng)
        .addTo(layerGroup)
        .bindPopup(`<strong>${escapeHtml(centreName)}</strong>`)
        .bindTooltip(escapeHtml(centreName), { permanent:false, direction:"top", offset:[0,-8] })
        .openPopup();

      // Radius ring + glow
      radiusGlow = L.circle(cLatLng, {
        radius: radiusKm * 1000,
        fill: false,
        color: ringColor,
        opacity: 0.18,
        weight: 14,
        interactive: false
      }).addTo(map);

      radiusCircle = L.circle(cLatLng, {
        radius: radiusKm * 1000,
        fill: false,
        color: ringColor,
        opacity: 0.95,
        weight: 6,
        dashArray: "8 8"
      }).addTo(map);

      addLegend(ringColor);

      // Store ring bounds for Fit radius
      lastRingBounds = radiusCircle.getBounds();

      // Geocode hubs order-preserving
      const postcodeList = hubs.map(h => h.postcode);
      const bulk = await geocodeBulkOrdered(postcodeList);

      let inside = 0, outside = 0, mapped = 0;
      const allLatLngs = [cLatLng];
      const failed = [];

      bulk.forEach((item, idx) => {
        const meta = hubs[idx];
        const res = item?.result;

        if (!res){
          failed.push(`${meta.name} (${formatPostcode(meta.postcode)})`);
          return;
        }

        const ll = [res.latitude, res.longitude];
        allLatLngs.push(ll);
        mapped++;

        const d = distanceKm(centre.latitude, centre.longitude, res.latitude, res.longitude);
        if (d <= radiusKm) inside++; else outside++;

        const marker = L.marker(ll, { icon: HUB_ICON }).addTo(layerGroup);
        marker.bindTooltip(escapeHtml(meta.name), { direction:"top", offset:[0,-6], opacity:0.95, sticky:true });
        marker.bindPopup(`<strong>${escapeHtml(meta.name)}</strong>`);
      });

      // Fit all bounds (centre + mapped hubs)
      lastAllBounds = L.latLngBounds(allLatLngs);
      map.fitBounds(lastAllBounds, { padding: [30,30] });

      setCounts(inside, outside, mapped);

      if (failed.length){
        // Keep it human + actionable
        const msg =
          `Some hubs couldn’t be mapped (${failed.length}).\n\n` +
          `These postcodes weren’t returned by postcodes.io:\n- ` +
          failed.slice(0, 30).join("\n- ") +
          (failed.length > 30 ? `\n… (+${failed.length - 30} more)` : "");
        setError(msg);
      }
    } catch (e){
      setError(e?.message || String(e));
      setCounts(0,0,0);
    } finally {
      $("runBtn").disabled = false;
      refreshReadiness();
    }
  }

  // =========================
  // Helpers
  // =========================
  function debounce(fn, ms){
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // =========================
  // Inputs that affect readiness
  // =========================
  $("centre").addEventListener("input", debounce(() => {
    // basic UI cue only; real validation happens when mapping
    refreshReadiness();
  }, 150));
  $("radius").addEventListener("input", debounce(refreshReadiness, 150));

  // Initial state
  setMode("bulk");
  setHubState("empty");
  validateManual(); // sets manual panel stats (even if hidden)
  refreshReadiness();
</script>
</body>
</html>
