<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>National Digital Inclusion Network – Hub Mapper</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- SheetJS (optional: XLSX/XLS parsing). CSV will work even if this fails. -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      /* Palette */
      --bg: #ffffff;
      --ink: #031366;
      --muted: #e5e5e5;
      --teal: #00a39e;
      --orange: #f55426;
      --yellow: #f7bf29;
      --magenta: #f529a6;
      --danger: #cf1c45;

      /* Layout */
      --radius: 16px;
      --shadow: 0 10px 24px rgba(3,19,102,.08);
      --shadow2: 0 12px 28px rgba(3,19,102,.12);

      /* Accessibility */
      --base: 16px;
      --lh: 1.55;
      --focus: 0 0 0 4px rgba(0,163,158,.18);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-size: var(--base);
      line-height: var(--lh);
      color: var(--ink);
      background: #f7f8ff;
      font-family: "Rubik", Helvetica, Arial, sans-serif;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap{
      display:flex;
      height:100vh;
      width:100%;
      overflow:hidden;
    }

    /* Sidebar (retractable) */
    aside.sidebar{
      width: 410px;
      min-width: 320px;
      background: var(--bg);
      border-right: 1px solid var(--muted);
      padding: 16px;
      overflow-y:auto;
      position: relative;
      transition: width .18s ease, padding .18s ease;
      z-index: 2;
    }

    body.sidebarCollapsed aside.sidebar{
      width: 0;
      min-width: 0;
      padding: 0;
      border-right: 0;
      overflow: hidden;
    }

    /* Toggle button (VERY visible) */
    .sidebarToggle{
      position: absolute;
      top: 14px;
      right: -18px;               /* hangs over map edge */
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(3,19,102,.18);
      background: var(--ink);
      color: #fff;
      font-size: 24px;
      font-weight: 900;
      line-height: 1;
      cursor: pointer;
      box-shadow: 0 12px 28px rgba(3,19,102,.22);
      display: grid;
      place-items: center;
      z-index: 9999;              /* above map controls */
      user-select:none;
    }
    .sidebarToggle:focus-visible{
      outline:none;
      box-shadow: var(--shadow2), var(--focus);
    }

    body.sidebarCollapsed .sidebarToggle{
      left: 14px;                  /* moves onto map */
      right: auto;
      top: 14px;
    }

    /* Brand header */
    .brand{
      display:flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 10px 14px;
      border-bottom: 1px solid var(--muted);
      margin-bottom: 14px;
    }
    .brand img{
      height: 38px;
      max-width: 240px;
      width: auto;
      display:block;
    }
    .brand .title{ display:flex; flex-direction:column; line-height:1.2; }
    .brand .title strong{ font-size: 18px; letter-spacing:.2px; line-height: 1.25; }
    .brand .title span{ font-size: 13px; color: rgba(3,19,102,.76); }

    /* Step cards */
    .step{
      position: relative;
      background: #fff;
      border: 1px solid var(--muted);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 18px 20px;
      margin-bottom: 12px;
      overflow:hidden;
    }
    .step::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 6px;
      background: var(--teal);
    }
    .step.step2::before{ background: var(--orange); }
    .step.step3::before{ background: var(--yellow); }

    .sectionHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    h2{
      font-size: 14px;
      margin:0;
      letter-spacing:.2px;
      line-height: 1.25;
    }
    .badge{
      font-size: 12px;
      font-weight: 900;
      color: var(--ink);
      background: rgba(3,19,102,.06);
      border: 1px solid rgba(3,19,102,.10);
      padding: 4px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .statusPill{
      font-size: 12px;
      font-weight: 900;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(3,19,102,.12);
      background: rgba(3,19,102,.04);
      color: rgba(3,19,102,.88);
      white-space:nowrap;
    }
    .statusPill.ok{
      border-color: rgba(0,163,158,.30);
      background: rgba(0,163,158,.10);
    }
    .statusPill.warn{
      border-color: rgba(245,84,38,.30);
      background: rgba(245,84,38,.10);
    }
    .statusPill.bad{
      border-color: rgba(207,28,69,.30);
      background: rgba(207,28,69,.10);
    }

    label{
      font-size: 14px;
      font-weight: 800;
      display:block;
      margin: 12px 0 6px;
      line-height: 1.25;
    }

    input, textarea, select, button{ font-family: inherit; }

    input, textarea, select{
      width:100%;
      min-height: 44px;            /* touch target */
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 11px 12px;
      font-size: 15px;
      outline: none;
      background: #fff;
      color: var(--ink);
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(0,163,158,.55);
      box-shadow: var(--focus);
    }
    input.invalid{
      border-color: rgba(207,28,69,.55);
      box-shadow: 0 0 0 4px rgba(207,28,69,.12);
    }

    .hint{
      font-size: 14px;
      color: rgba(3,19,102,.80);
      margin-top: 8px;
      line-height: 1.45;
    }
    .microHint{
      font-size: 13px;
      color: rgba(3,19,102,.74);
      margin-top: 8px;
      line-height: 1.45;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items:end;
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }

    .btn{
      border: 1px solid rgba(3,19,102,.16);
      border-radius: 12px;
      padding: 11px 12px;
      font-weight: 900;
      cursor:pointer;
      touch-action: manipulation;
      user-select:none;
      background:#fff;
      color: var(--ink);
      font-size: 14px;
      min-height: 46px;
    }
    .btn:focus-visible{ outline:none; box-shadow: var(--shadow2), var(--focus); }
    .btnPrimary{
      background: var(--ink);
      color:#fff;
      border-color: var(--ink);
      flex: 1;
      min-width: 160px;
      box-shadow: 0 10px 18px rgba(3,19,102,.18);
    }
    .btnPrimary:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }
    .btnSmall{
      padding: 9px 10px;
      border-radius: 10px;
      font-size: 13px;
      min-height: 40px;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      padding: 6px;
      background: rgba(3,19,102,.04);
      border: 1px solid var(--muted);
      border-radius: 14px;
      margin-top: 6px;
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      font-weight: 900;
      font-size: 13px;
      color: rgba(3,19,102,.88);
      cursor:pointer;
    }
    .tab.active{
      background:#fff;
      border-color: rgba(3,19,102,.14);
      color: var(--ink);
      box-shadow: 0 8px 18px rgba(3,19,102,.08);
    }
    .tab:focus-visible{ outline:none; box-shadow: var(--shadow2), var(--focus); }

    /* Upload area (NO dashed line) */
    .dropzone{
      border: 1px solid rgba(3,19,102,.14);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 10px 24px rgba(3,19,102,.06);
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin-top: 10px;
    }
    .dropzone.dragover{
      border-color: var(--teal);
      box-shadow: 0 0 0 4px rgba(0,163,158,.12);
    }
    .dzTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .dzTop strong{ font-size: 14px; font-weight: 900; }
    .dzTop .small{ font-size: 13px; color: rgba(3,19,102,.76); }

    .fileBtn{
      display:inline-block;
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid rgba(3,19,102,.16);
      font-weight: 900;
      cursor:pointer;
      white-space:nowrap;
      font-size: 13px;
      min-height: 44px;
    }

    .fileInput{
      position:absolute;
      left:-9999px;
      width:1px;
      height:1px;
      opacity:0.01;
    }

    .uploadStatus{
      font-size: 13px;
      font-weight: 900;
      color: rgba(3,19,102,.86);
    }

    /* Manual entry */
    .manualWrap{
      margin-top: 10px;
      border: 1px solid var(--muted);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow);
    }
    .manualHead{
      display:grid;
      grid-template-columns: 42px 1fr 140px 44px;
      padding: 10px 12px;
      background: rgba(3,19,102,.04);
      border-bottom: 1px solid var(--muted);
      font-size: 13px;
      font-weight: 900;
      color: rgba(3,19,102,.78);
    }
    .manualGridRow{
      display:grid;
      grid-template-columns: 42px 1fr 140px 44px;
      border-bottom: 1px solid var(--muted);
      align-items:center;
    }
    .manualGridRow:last-child{ border-bottom:0; }
    .cell{ padding: 8px 10px; }
    .cellNum{ text-align:center; font-weight: 900; color: rgba(3,19,102,.55); }

    .cell input{
      width:100%;
      border: 1px solid rgba(3,19,102,.10);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 14px;
      min-height: 44px;
    }

    .cellBtn{ display:flex; justify-content:center; }
    .iconBtn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(3,19,102,.14);
      background: #fff;
      cursor:pointer;
      font-weight: 900;
      color: rgba(3,19,102,.70);
    }
    .iconBtn:focus-visible{ outline:none; box-shadow: var(--shadow2), var(--focus); }

    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .stat{
      border:1px solid var(--muted);
      border-radius: 14px;
      padding: 10px 10px;
      background: #fff;
      box-shadow: var(--shadow);
    }
    .stat .k{ font-size: 12px; color: rgba(3,19,102,.75); font-weight: 900; }
    .stat .v{ font-size: 18px; font-weight: 1000; margin-top: 4px; }

    .error{
      margin-top: 10px;
      font-size: 13px;
      color: var(--danger);
      white-space: pre-wrap;
      font-weight: 900;
      line-height: 1.45;
    }

    /* Map */
    #map{ flex: 1; height: 100vh; }

    /* Legend */
    .legend{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(3,19,102,.12);
      border-radius: 14px;
      box-shadow: var(--shadow2);
      padding: 10px 10px;
      color: var(--ink);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      font-size: 13px;
      line-height: 1.45;
      min-width: 190px;
    }
    .legendTitle{
      font-weight: 1000;
      margin-bottom: 6px;
      letter-spacing: .2px;
      font-size: 13px;
    }
    .legendRow{ display:flex; align-items:center; gap:8px; margin: 6px 0; }
    .legendDot{
      width: 12px; height: 12px; border-radius: 999px;
      background: var(--ink);
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.18);
      flex: 0 0 auto;
    }
    .legendRing{
      width: 12px; height: 12px; border-radius: 999px;
      border: 2px solid var(--teal);
      background: transparent;
      flex: 0 0 auto;
    }
    .legendNote{
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(3,19,102,.12);
      color: rgba(3,19,102,.80);
      font-size: 12px;
      line-height: 1.4;
    }

    @media (max-width: 900px){
      .wrap{ flex-direction: column; }
      aside.sidebar{
        width: 100%;
        min-width: 100%;
        border-right:none;
        border-bottom: 1px solid var(--muted);
      }
      body.sidebarCollapsed aside.sidebar{
        width: 100%;
        min-width: 100%;
        padding: 12px;
        border-bottom: 1px solid var(--muted);
      }
      body.sidebarCollapsed .brand,
      body.sidebarCollapsed .step,
      body.sidebarCollapsed .hint,
      body.sidebarCollapsed .microHint{
        display:block;
      }
      .sidebarToggle{
        right: 14px;
        left: auto;
        top: 14px;
      }
      #map{ height: 60vh; }
      .manualHead, .manualGridRow{ grid-template-columns: 36px 1fr 120px 40px; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <aside class="sidebar" id="sidebar">
    <button id="toggleSidebar" class="sidebarToggle" type="button" aria-label="Hide sidebar" title="Hide sidebar">‹</button>

    <div class="brand">
      <img src="./gtf-logo-full.png" alt="Good Things Foundation logo">
      <div class="title">
        <strong>National Digital Inclusion Network Mapping</strong>
        <span>Postcode-based hub visualiser</span>
      </div>
    </div>

    <!-- Step 1 -->
    <section class="step step1">
      <div class="sectionHeader">
        <h2>Step 1 — Central location</h2>
        <span class="badge">1</span>
      </div>

      <label for="centre">Central postcode</label>
      <input id="centre" placeholder="e.g. E1 6AN" autocapitalize="characters">

      <label for="centreName">Centre name (optional)</label>
      <input id="centreName" placeholder="e.g. Birmingham City Centre">

      <div class="hint">We’ll use this as the anchor point for the radius ring and distance calculations.</div>
    </section>

    <!-- Step 2 -->
    <section class="step step2">
      <div class="sectionHeader">
        <h2>Step 2 — Hubs to map</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <span id="dataStatus" class="statusPill warn">No hubs loaded</span>
          <span class="badge">2</span>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Hub input method">
        <button id="tabBulk" class="tab active" type="button" role="tab" aria-selected="true">Bulk Upload</button>
        <button id="tabManual" class="tab" type="button" role="tab" aria-selected="false">Manual Input</button>
      </div>

      <!-- Bulk panel -->
      <div id="panelBulk">
        <div id="dropzone" class="dropzone">
          <div class="dzTop">
            <div>
              <strong>Upload a file</strong>
              <div class="small">CSV recommended · XLSX supported (if library loads)</div>
            </div>

            <button id="chooseFileBtn" class="fileBtn" type="button">Choose file</button>
            <input id="fileInput" class="fileInput" type="file"
              accept=".xlsx,.xls,.csv,.tsv,.txt,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv,text/tab-separated-values">
          </div>

          <div class="hint">
            Required format: <strong>two columns, no headers</strong><br>
            Column A = <strong>Hub Name</strong>, Column B = <strong>Postcode</strong>
          </div>

          <div class="actions" style="margin-top:8px;">
            <button id="templateBtn" class="btn btnSmall" type="button">Download CSV template</button>
            <button id="clearUploadBtn" class="btn btnSmall" type="button">Clear upload</button>
          </div>

          <div class="uploadStatus" id="uploadStatus">No file loaded yet.</div>
        </div>

        <div class="microHint" style="margin-top:10px;">
          Tip: once mapped, <strong>hover</strong> (desktop) or <strong>tap</strong> (mobile) a hub to see its name.
        </div>
      </div>

      <!-- Manual panel -->
      <div id="panelManual" style="display:none; margin-top:10px;">
        <div class="hint">Add hubs manually below. Use <strong>Add row</strong> to insert more lines.</div>

        <div class="manualWrap">
          <div class="manualHead">
            <div>#</div>
            <div>Hub name</div>
            <div>Postcode</div>
            <div></div>
          </div>
          <div id="manualRows"></div>
        </div>

        <div class="actions" style="margin-top:10px;">
          <button id="addRowBtn" class="btn btnSmall" type="button">Add row</button>
          <button id="clearManualBtn" class="btn btnSmall" type="button">Clear manual</button>
        </div>

        <div class="microHint">
          Tip: once mapped, <strong>hover</strong> (desktop) or <strong>tap</strong> (mobile) a hub to see its name.
        </div>
      </div>
    </section>

    <!-- Step 3 -->
    <section class="step step3">
      <div class="sectionHeader">
        <h2>Step 3 — Parameters</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <span id="readyStatus" class="statusPill warn">Not ready</span>
          <span class="badge">3</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="radius">Radius (km)</label>
          <input id="radius" type="number" value="5" step="0.1" min="0.1">
        </div>

        <div>
          <label for="ringPreset">Ring colour</label>
          <select id="ringPreset">
            <option value="#00a39e" selected>Teal</option>
            <option value="#f55426">Orange</option>
            <option value="#031366">Ink</option>
            <option value="#f529a6">Magenta</option>
            <option value="#f7bf29">Yellow</option>
            <option value="custom">Custom…</option>
          </select>
        </div>
      </div>

      <div id="customColorWrap" style="display:none; margin-top:10px;">
        <label for="ringColor">Custom colour</label>
        <input id="ringColor" type="color" value="#00a39e" style="padding:6px; height:42px;">
      </div>

      <div class="actions">
        <button id="runBtn" class="btn btnPrimary" type="button" disabled>Map hubs</button>
        <button id="clearAllBtn" class="btn" type="button">Clear</button>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button id="fitRingBtn" class="btn btnSmall" type="button">Fit radius</button>
        <button id="fitAllBtn" class="btn btnSmall" type="button">Fit all hubs</button>
        <button id="resetViewBtn" class="btn btnSmall" type="button">Reset view</button>
      </div>

      <div class="stats">
        <div class="stat"><div class="k">Inside radius</div><div class="v" id="inCount">0</div></div>
        <div class="stat"><div class="k">Outside radius</div><div class="v" id="outCount">0</div></div>
        <div class="stat"><div class="k">Mapped</div><div class="v" id="totalCount">0</div></div>
      </div>

      <div class="error" id="err"></div>
      <div class="hint">On the map: <strong>hover</strong> (desktop) or <strong>tap</strong> (mobile) a hub icon to see the hub name.</div>
    </section>

    <div class="microHint" style="padding: 0 4px 10px;">
      Basemap: CARTO Positron · Geocoding: postcodes.io · Hosted via GitHub Pages
    </div>
  </aside>

  <div id="map"></div>
</div>

<script>
  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);

  function setError(msg){ $("err").textContent = msg || ""; }
  function setCounts(i,o,t){
    $("inCount").textContent = i;
    $("outCount").textContent = o;
    $("totalCount").textContent = t;
  }
  function pill(el, kind, text){
    el.classList.remove("ok","warn","bad");
    el.classList.add(kind);
    el.textContent = text;
  }

  function norm(pc){ return (pc || "").trim().toUpperCase().replace(/\s+/g, ""); }

  function formatPostcode(pc){
    const n = norm(pc);
    if (n.length <= 3) return n;
    return n.slice(0, n.length - 3) + " " + n.slice(-3);
  }

  const POSTCODE_RE = /^([A-Z]{1,2}\d[A-Z\d]?)(\d[A-Z]{2})$/;
  function looksLikePostcode(s){
    const n = norm(s);
    return !!n && POSTCODE_RE.test(n);
  }

  function debounce(fn, ms){
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // =========================
  // Sidebar toggle
  // =========================
  const toggleBtn = $("toggleSidebar");
  toggleBtn.addEventListener("click", () => {
    document.body.classList.toggle("sidebarCollapsed");
    const collapsed = document.body.classList.contains("sidebarCollapsed");
    toggleBtn.textContent = collapsed ? "›" : "‹";
    toggleBtn.setAttribute("aria-label", collapsed ? "Show sidebar" : "Hide sidebar");
    toggleBtn.title = collapsed ? "Show sidebar" : "Hide sidebar";
    setTimeout(() => map.invalidateSize(), 200);
  });

  // =========================
  // Map setup
  // =========================
  const map = L.map("map").setView([54.5, -3.2], 6);

  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}" + (L.Browser.retina ? "@2x.png" : ".png"),
    {
      subdomains: "abcd",
      maxZoom: 20,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
        '&copy; <a href="https://carto.com/attributions">CARTO</a>'
    }
  ).addTo(map);

  const layerGroup = L.layerGroup().addTo(map);
  let radiusCircle = null;
  let radiusGlow = null;
  let legendControl = null;

  let lastRingBounds = null;
  let lastAllBounds = null;

  const HUB_ICON = L.icon({
    iconUrl: "./gtf-logo.png",
    iconSize: [22, 22],
    iconAnchor: [11, 11],
    popupAnchor: [0, -10]
  });

  // =========================
  // State
  // =========================
  let hubMode = "bulk";     // bulk | manual
  let uploadData = null;    // { validHubs: [{name, postcode}], invalidRows: [...] }
  let hubReady = false;

  function refreshReadiness(){
    const centreOk = !!norm($("centre").value);
    const radiusKm = Number($("radius").value);
    const radiusOk = Number.isFinite(radiusKm) && radiusKm > 0;

    let hubsOk = false;
    if (hubMode === "bulk"){
      hubsOk = !!(uploadData && uploadData.validHubs && uploadData.validHubs.length);
    } else {
      hubsOk = validateManual(false); // validate but don't spam errors
    }

    const ready = centreOk && radiusOk && hubsOk;
    pill($("readyStatus"), ready ? "ok" : "warn", ready ? "Ready" : "Not ready");
    $("runBtn").disabled = !ready;
    return ready;
  }

  // =========================
  // Ring colour preset
  // =========================
  const ringPreset = $("ringPreset");
  const customColorWrap = $("customColorWrap");
  const ringColorInput = $("ringColor");

  function getRingColor(){
    const preset = ringPreset.value;
    if (preset === "custom") return ringColorInput.value || "#00a39e";
    return preset || "#00a39e";
  }

  ringPreset.addEventListener("change", () => {
    const isCustom = ringPreset.value === "custom";
    customColorWrap.style.display = isCustom ? "block" : "none";
    if (!isCustom) ringColorInput.value = ringPreset.value;
  });

  // =========================
  // Legend
  // =========================
  function addLegend(ringColor){
    if (legendControl) { map.removeControl(legendControl); legendControl = null; }

    legendControl = L.control({ position: "bottomright" });
    legendControl.onAdd = function(){
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div class="legendTitle">Legend</div>
        <div class="legendRow"><span class="legendDot"></span><span>Centre</span></div>
        <div class="legendRow">
          <img src="./gtf-logo.png" alt="" style="width:16px;height:16px;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,.15);">
          <span>Hub</span>
        </div>
        <div class="legendRow"><span class="legendRing" style="border-color:${ringColor}"></span><span>Radius ring</span></div>
        <div class="legendNote">
          Tip: <strong>hover</strong> (desktop) or <strong>tap</strong> (mobile) a hub to see details.
        </div>
      `;
      L.DomEvent.disableClickPropagation(div);
      L.DomEvent.disableScrollPropagation(div);
      return div;
    };
    legendControl.addTo(map);
  }

  // =========================
  // Tabs logic
  // =========================
  function setMode(mode){
    hubMode = mode;
    if (mode === "bulk"){
      $("tabBulk").classList.add("active");
      $("tabManual").classList.remove("active");
      $("panelBulk").style.display = "block";
      $("panelManual").style.display = "none";

      if (uploadData && uploadData.validHubs?.length){
        pill($("dataStatus"), uploadData.invalidRows?.length ? "warn" : "ok",
          uploadData.invalidRows?.length ? `${uploadData.validHubs.length} loaded · review` : `${uploadData.validHubs.length} hubs loaded`);
      } else {
        pill($("dataStatus"), "warn", "No hubs loaded");
      }

    } else {
      $("tabManual").classList.add("active");
      $("tabBulk").classList.remove("active");
      $("panelManual").style.display = "block";
      $("panelBulk").style.display = "none";
      validateManual(true);
    }
    refreshReadiness();
  }

  $("tabBulk").addEventListener("click", () => setMode("bulk"));
  $("tabManual").addEventListener("click", () => setMode("manual"));

  // =========================
  // Manual grid
  // =========================
  const manualRowsEl = $("manualRows");

  function makeManualRow(idx){
    const row = document.createElement("div");
    row.className = "manualGridRow";
    row.dataset.row = String(idx);

    const cNum = document.createElement("div");
    cNum.className = "cell cellNum";
    cNum.textContent = String(idx);

    const cName = document.createElement("div");
    cName.className = "cell";
    const nameInput = document.createElement("input");
    nameInput.placeholder = "Hub name";
    nameInput.addEventListener("input", debounce(() => validateManual(true), 150));
    cName.appendChild(nameInput);

    const cPc = document.createElement("div");
    cPc.className = "cell";
    const pcInput = document.createElement("input");
    pcInput.placeholder = "Postcode";
    pcInput.autocapitalize = "characters";
    pcInput.addEventListener("blur", () => { pcInput.value = formatPostcode(pcInput.value); validateManual(true); });
    pcInput.addEventListener("input", debounce(() => validateManual(true), 150));
    cPc.appendChild(pcInput);

    const cDel = document.createElement("div");
    cDel.className = "cell cellBtn";
    const delBtn = document.createElement("button");
    delBtn.className = "iconBtn";
    delBtn.type = "button";
    delBtn.title = "Delete row";
    delBtn.textContent = "×";
    delBtn.addEventListener("click", () => {
      row.remove();
      renumberManual();
      validateManual(true);
    });
    cDel.appendChild(delBtn);

    row.appendChild(cNum);
    row.appendChild(cName);
    row.appendChild(cPc);
    row.appendChild(cDel);
    return row;
  }

  function renumberManual(){
    const rows = Array.from(manualRowsEl.querySelectorAll(".manualGridRow"));
    rows.forEach((r, i) => {
      r.dataset.row = String(i+1);
      r.querySelector(".cellNum").textContent = String(i+1);
    });
  }

  function addManualRow(){
    const nextIdx = manualRowsEl.querySelectorAll(".manualGridRow").length + 1;
    manualRowsEl.appendChild(makeManualRow(nextIdx));
    renumberManual();
  }

  // init 10 rows
  for (let i=0; i<10; i++) addManualRow();

  $("addRowBtn").addEventListener("click", () => addManualRow());
  $("clearManualBtn").addEventListener("click", () => {
    manualRowsEl.innerHTML = "";
    for (let i=0; i<10; i++) addManualRow();
    validateManual(true);
  });

  function getManualHubs(){
    const rows = Array.from(manualRowsEl.querySelectorAll(".manualGridRow"));
    const hubs = [];
    rows.forEach(r => {
      const inputs = r.querySelectorAll("input");
      const name = (inputs[0]?.value || "").trim();
      const pcRaw = (inputs[1]?.value || "").trim();
      const postcode = norm(pcRaw);
      if (!name && !postcode) return;
      hubs.push({ name: name || "Hub", postcode, _pcInput: inputs[1] });
    });
    return hubs;
  }

  function validateManual(updatePill){
    const hubs = getManualHubs();
    hubs.forEach(h => h._pcInput?.classList.remove("invalid"));

    const valid = hubs.filter(h => h.postcode && looksLikePostcode(h.postcode));
    const invalid = hubs.filter(h => h.postcode && !looksLikePostcode(h.postcode));

    invalid.forEach(h => h._pcInput?.classList.add("invalid"));

    if (updatePill){
      if (valid.length){
        pill($("dataStatus"), invalid.length ? "warn" : "ok",
          invalid.length ? `${valid.length} loaded · review` : `${valid.length} hubs loaded`);
      } else {
        pill($("dataStatus"), "warn", "No hubs loaded");
      }
    }

    return valid.length > 0 && invalid.length === 0;
  }

  // =========================
  // Upload handling
  // =========================
  const dropzone = $("dropzone");
  const fileInput = $("fileInput");
  const uploadStatus = $("uploadStatus");

  $("chooseFileBtn").addEventListener("click", () => fileInput.click());

  $("templateBtn").addEventListener("click", () => {
    const csv = `Example Hub,SW1A 1AA\nAnother Hub,B1 1AA\n`;
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ndin-hubs-template.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("clearUploadBtn").addEventListener("click", () => {
    uploadData = null;
    uploadStatus.textContent = "No file loaded yet.";
    pill($("dataStatus"), "warn", "No hubs loaded");
    refreshReadiness();
  });

  ["dragenter","dragover"].forEach(evt => {
    dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      dropzone.classList.add("dragover");
    });
  });
  ["dragleave","drop"].forEach(evt => {
    dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      dropzone.classList.remove("dragover");
    });
  });
  dropzone.addEventListener("drop", async (e) => {
    const file = e.dataTransfer?.files?.[0];
    if (file) await handleUploadFile(file);
  });

  fileInput.addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (f) await handleUploadFile(f);
    fileInput.value = "";
  });

  function parseCSV(text){
    const rows = [];
    let row = [], cur = "", inQuotes = false;
    for (let i=0; i<text.length; i++){
      const ch = text[i];
      const next = text[i+1];
      if (ch === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === "," && !inQuotes){
        row.push(cur); cur = "";
      } else if ((ch === "\n" || ch === "\r") && !inQuotes){
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); rows.push(row);
        row = []; cur = "";
      } else cur += ch;
    }
    if (cur.length || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  function normaliseRowsToTwoCols(rows){
    const cleaned = [];
    for (const r of rows){
      const a = (r?.[0] ?? "").toString().trim();
      const b = (r?.[1] ?? "").toString().trim();
      if (!a && !b) continue;
      cleaned.push([a,b]);
    }
    return cleaned;
  }

  function assessSwap(twoCols){
    let expected = 0;
    let swapped = 0;
    for (const [a,b] of twoCols){
      const aIsPC = looksLikePostcode(a);
      const bIsPC = looksLikePostcode(b);
      if (bIsPC && !aIsPC) expected++;
      else if (aIsPC && !bIsPC) swapped++;
    }
    return { expected, swapped };
  }

  async function handleUploadFile(file){
    setError("");
    uploadData = null;
    uploadStatus.textContent = "Loading…";

    try{
      const lower = (file.name || "").toLowerCase();
      const isCSV = lower.endsWith(".csv") || file.type.includes("csv") || file.type === "text/plain";

      let rows;
      if (isCSV){
        const text = await file.text();
        rows = parseCSV(text);
      } else {
        if (typeof XLSX === "undefined"){
          throw new Error("Spreadsheet library didn’t load (XLSX missing). CSV uploads will work; for XLSX refresh or convert to CSV.");
        }
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: "array" });
        const sheetName = wb.SheetNames?.[0];
        if (!sheetName) throw new Error("No sheet found in that spreadsheet.");
        const ws = wb.Sheets[sheetName];
        rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false, defval: "" });
      }

      let twoCols = normaliseRowsToTwoCols(rows);
      if (!twoCols.length) throw new Error("No usable rows found. Put data in the first two columns.");

      // header-ish detect
      const firstA = (twoCols[0][0] || "").toString().toLowerCase();
      const firstB = (twoCols[0][1] || "").toString().toLowerCase();
      const headerish = (firstA.includes("hub") || firstA.includes("name") || firstA.includes("organisation")) &&
                        (firstB.includes("post") || firstB.includes("zip") || firstB.includes("code"));
      if (headerish){
        const ok = window.confirm("Your first row looks like a header.\n\nThis tool expects NO headers.\n\nOK = Continue anyway\nCancel = Stop");
        if (!ok) throw new Error("Upload cancelled (header row detected).");
      }

      const { expected, swapped } = assessSwap(twoCols);
      if (swapped > 0 && swapped >= expected * 1.5){
        const ok = window.confirm(
          "Your file looks like the columns may be the wrong way around.\n\nExpected: A = Hub Name, B = Postcode\n\nOK = Continue (swap columns)\nCancel = Stop"
        );
        if (!ok) throw new Error("Upload cancelled.");
        twoCols = twoCols.map(([a,b]) => [b,a]);
      }

      const validHubs = [];
      const invalidRows = [];

      twoCols.forEach((r, i) => {
        const nameRaw = (r[0] ?? "").toString().trim();
        const postcodeRaw = (r[1] ?? "").toString().trim();
        const pc = norm(postcodeRaw);

        if (!nameRaw && !pc) return;

        if (!pc || !looksLikePostcode(pc)){
          invalidRows.push({ row:i+1, nameRaw, postcodeRaw });
        } else {
          validHubs.push({ name: nameRaw || "Hub", postcode: pc });
        }
      });

      uploadData = { validHubs, invalidRows };

      uploadStatus.textContent =
        `Loaded "${file.name}": ${validHubs.length} valid hub(s)` +
        (invalidRows.length ? ` · ${invalidRows.length} invalid row(s)` : "") +
        ".";

      if (!validHubs.length){
        pill($("dataStatus"), "warn", "No hubs loaded");
      } else if (invalidRows.length){
        pill($("dataStatus"), "warn", `${validHubs.length} loaded · review`);
      } else {
        pill($("dataStatus"), "ok", `${validHubs.length} hubs loaded`);
      }

      setMode("bulk");
      refreshReadiness();

    } catch (e){
      uploadData = null;
      uploadStatus.textContent = "No file loaded yet.";
      pill($("dataStatus"), "warn", "No hubs loaded");
      setError(e?.message || String(e));
      refreshReadiness();
    }
  }

  // =========================
  // Geocoding (order-preserving)
  // =========================
  async function geocodeSingle(pc) {
    const r = await fetch("https://api.postcodes.io/postcodes/" + encodeURIComponent(pc));
    const j = await r.json();
    if (!j.result) throw new Error("Invalid centre postcode");
    return j.result;
  }

  async function geocodeBulkOrdered(postcodes) {
    const r = await fetch("https://api.postcodes.io/postcodes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ postcodes })
    });
    const j = await r.json();
    if (!j.result) throw new Error("Bulk lookup failed");
    return j.result; // [{query,result}]
  }

  function distanceKm(aLat, aLon, bLat, bLon) {
    const R = 6371;
    const dLat = (bLat - aLat) * Math.PI / 180;
    const dLon = (bLon - aLon) * Math.PI / 180;
    const lat1 = aLat * Math.PI / 180;
    const lat2 = bLat * Math.PI / 180;
    const h =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
    return 2 * R * Math.asin(Math.sqrt(h));
  }

  function clearMapOnly(){
    layerGroup.clearLayers();
    if (radiusCircle) { map.removeLayer(radiusCircle); radiusCircle = null; }
    if (radiusGlow) { map.removeLayer(radiusGlow); radiusGlow = null; }
    if (legendControl) { map.removeControl(legendControl); legendControl = null; }
    lastRingBounds = null;
    lastAllBounds = null;
    setCounts(0,0,0);
  }

  // =========================
  // Run mapping
  // =========================
  $("runBtn").addEventListener("click", run);

  async function run(){
    setError("");
    $("runBtn").disabled = true;
    clearMapOnly();

    try{
      const centrePc = norm($("centre").value);
      const centreName = ($("centreName").value || "").trim() || "Centre";
      const radiusKm = Number($("radius").value);
      const ringColor = getRingColor();

      if (!centrePc) throw new Error("Enter a central postcode.");
      if (!Number.isFinite(radiusKm) || radiusKm <= 0) throw new Error("Radius must be a positive number (km).");

      let hubs;
      if (hubMode === "bulk"){
        if (!uploadData || !uploadData.validHubs?.length) throw new Error("Upload hubs first.");
        if (uploadData.invalidRows?.length){
          const ok = window.confirm(
            `Your upload contains invalid rows.\n\nOK = Map only the valid hubs (${uploadData.validHubs.length})\nCancel = Go back and fix`
          );
          if (!ok) throw new Error("Mapping cancelled.");
        }
        hubs = uploadData.validHubs;
      } else {
        const manual = getManualHubs().filter(h => h.postcode);
        const invalid = manual.filter(h => !looksLikePostcode(h.postcode));
        if (invalid.length) throw new Error("Fix invalid postcodes in manual entry before mapping.");
        hubs = manual.map(h => ({ name: h.name, postcode: h.postcode }));
      }

      const centre = await geocodeSingle(centrePc);
      const cLatLng = [centre.latitude, centre.longitude];

      // Centre marker
      L.marker(cLatLng)
        .addTo(layerGroup)
        .bindPopup(`<strong>${escapeHtml(centreName)}</strong>`)
        .bindTooltip(escapeHtml(centreName), { permanent:false, direction:"top", offset:[0,-8] })
        .openPopup();

      // Radius glow + thicker solid ring (no dashes)
      radiusGlow = L.circle(cLatLng, {
        radius: radiusKm * 1000,
        fill: false,
        color: ringColor,
        opacity: 0.18,
        weight: 14,
        interactive: false
      }).addTo(map);

      radiusCircle = L.circle(cLatLng, {
        radius: radiusKm * 1000,
        fill: false,
        color: ringColor,
        opacity: 0.95,
        weight: 6
      }).addTo(map);

      addLegend(ringColor);
      lastRingBounds = radiusCircle.getBounds();

      const bulk = await geocodeBulkOrdered(hubs.map(h => h.postcode));

      let inside = 0, outside = 0, mapped = 0;
      const allLatLngs = [cLatLng];
      const failed = [];

      bulk.forEach((item, idx) => {
        const meta = hubs[idx];
        const res = item?.result;

        if (!res){
          failed.push(`${meta.name} (${formatPostcode(meta.postcode)})`);
          return;
        }

        const ll = [res.latitude, res.longitude];
        allLatLngs.push(ll);
        mapped++;

        const d = distanceKm(centre.latitude, centre.longitude, res.latitude, res.longitude);
        if (d <= radiusKm) inside++; else outside++;

        const marker = L.marker(ll, { icon: HUB_ICON }).addTo(layerGroup);
        marker.bindTooltip(escapeHtml(meta.name), { direction:"top", offset:[0,-6], opacity:0.95, sticky:true });
        marker.bindPopup(`<strong>${escapeHtml(meta.name)}</strong>`);
      });

      lastAllBounds = L.latLngBounds(allLatLngs);
      map.fitBounds(lastAllBounds, { padding: [30,30] });

      setCounts(inside, outside, mapped);

      if (failed.length){
        setError(
          `Some hubs couldn’t be mapped (${failed.length}).\n\n` +
          `These postcodes weren’t returned by postcodes.io:\n- ` +
          failed.slice(0, 30).join("\n- ") +
          (failed.length > 30 ? `\n… (+${failed.length - 30} more)` : "")
        );
      }

    } catch (e){
      setError(e?.message || String(e));
      setCounts(0,0,0);
    } finally {
      $("runBtn").disabled = false;
      refreshReadiness();
    }
  }

  // =========================
  // Buttons (fit/reset/clear)
  // =========================
  $("fitRingBtn").addEventListener("click", () => {
    if (lastRingBounds) map.fitBounds(lastRingBounds, { padding: [30,30] });
  });

  $("fitAllBtn").addEventListener("click", () => {
    if (lastAllBounds) map.fitBounds(lastAllBounds, { padding: [30,30] });
  });

  $("resetViewBtn").addEventListener("click", () => {
    map.setView([54.5, -3.2], 6);
  });

  $("clearAllBtn").addEventListener("click", () => {
    setError("");
    $("centre").value = "";
    $("centreName").value = "";
    $("radius").value = "5";
    clearMapOnly();

    uploadData = null;
    uploadStatus.textContent = "No file loaded yet.";
    pill($("dataStatus"), "warn", "No hubs loaded");

    manualRowsEl.innerHTML = "";
    for (let i=0; i<10; i++) addManualRow();

    setMode("bulk");
    refreshReadiness();
  });

  // =========================
  // Input watchers
  // =========================
  $("centre").addEventListener("input", debounce(refreshReadiness, 150));
  $("radius").addEventListener("input", debounce(refreshReadiness, 150));

  // Init
  setMode("bulk");
  refreshReadiness();
</script>
</body>
</html>
