<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Inclusion Hubs – Mapper</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { display: flex; height: 100vh; }
    .panel {
      width: 380px; padding: 16px; overflow-y: auto;
      border-right: 1px solid #e6e6e6; background: #fafafa;
    }
    h1 { font-size: 16px; margin-bottom: 12px; }
    label { font-size: 12px; color: #444; display: block; margin-top: 10px; }
    input, textarea, button {
      width: 100%; padding: 10px; font-size: 14px;
      border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;
    }
    textarea { min-height: 120px; }
    textarea:disabled { background: #eee; color: #777; }
    button {
      background: #111; color: #fff; font-weight: 600;
      margin-top: 12px; cursor: pointer;
    }
    .small { font-size: 12px; color: #666; }
    .stats { font-size: 13px; margin-top: 10px; }
    .error { color: #b00020; font-size: 12px; margin-top: 8px; white-space: pre-wrap; }

    .dropzone {
      margin-top: 8px;
      padding: 14px;
      border: 2px dashed #bbb;
      border-radius: 8px;
      text-align: center;
      background: #fff;
      font-size: 12px;
      color: #555;
    }
    .dropzone.dragover {
      border-color: #111;
      background: #f0f0f0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
    }
    th { background: #f0f0f0; }

    #map { flex: 1; }

    @media (max-width: 900px) {
      .wrap { flex-direction: column; }
      .panel { width: 100%; border-right: none; border-bottom: 1px solid #e6e6e6; }
      #map { height: 60vh; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <h1>Digital Inclusion Hub Mapper</h1>

    <label>Central postcode</label>
    <input id="centre" placeholder="E1 6AN">

    <label>Centre name</label>
    <input id="centreName" placeholder="e.g. Birmingham City Centre">

    <label>Manual hub entry</label>
    <textarea id="hubs" placeholder="Hub name, postcode"></textarea>
    <div class="small">Format: <strong>name, postcode</strong> (one per line)</div>

    <label>Or upload hubs CSV</label>
    <input type="file" id="hubFile" accept=".csv">
    <div class="dropzone" id="dropzone">Or drag & drop CSV here</div>
    <div class="small" id="csvStatus">CSV: no headers · Column A = name · Column B = postcode</div>

    <label>Radius (km)</label>
    <input id="radius" type="number" value="5" step="0.1">

    <button onclick="run()">Map hubs</button>

    <div class="stats">
      Inside radius: <span id="inCount">0</span><br>
      Outside radius: <span id="outCount">0</span><br>
      Total mapped: <span id="totalCount">0</span>
    </div>

    <button id="exportBtn" style="display:none;">Export results CSV</button>

    <div id="preview"></div>
    <div class="error" id="err"></div>
  </div>

  <div id="map"></div>
</div>

<script>
  const map = L.map("map").setView([51.5074, -0.1278], 11);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}" +
    (L.Browser.retina ? "@2x.png" : ".png"),
    { subdomains: "abcd", maxZoom: 20 }
  ).addTo(map);

  const layerGroup = L.layerGroup().addTo(map);
  let radiusCircle, exportRows = [];

  const HUB_ICON = L.icon({
    iconUrl: "./gtf-logo.png",
    iconSize: [22,22],
    iconAnchor: [11,11]
  });

  const norm = pc => (pc||"").trim().toUpperCase().replace(/\s+/g,"");

  function parseCSV(text) {
    return text.split(/\r?\n/).filter(Boolean).map((l,i)=>{
      const c=l.split(",").map(x=>x.trim());
      if(c.length<2) throw `CSV error line ${i+1}`;
      return {name:c[0], postcode:norm(c[1])};
    });
  }

  function preview(hubs, source) {
    const rows = hubs.slice(0,5).map(h =>
      `<tr><td>${h.name}</td><td>${h.postcode}</td></tr>`).join("");
    document.getElementById("preview").innerHTML = `
      <div class="small">Preview (${source}, first ${Math.min(5,hubs.length)} rows)</div>
      <table><tr><th>Name</th><th>Postcode</th></tr>${rows}</table>`;
  }

  function distanceKm(aLat,aLon,bLat,bLon){
    const R=6371,dLat=(bLat-aLat)*Math.PI/180,dLon=(bLon-aLon)*Math.PI/180;
    const h=Math.sin(dLat/2)**2+Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(h));
  }

  async function run() {
    document.getElementById("err").textContent="";
    layerGroup.clearLayers(); exportRows=[];
    if(radiusCircle) map.removeLayer(radiusCircle);

    try {
      const centrePc = norm(centre.value);
      const centreName = centreNameInput.value || "Centre";
      const radiusKm = +radius.value;

      let hubs=[];
      if(hubFile.files.length){
        hubs=parseCSV(await hubFile.files[0].text());
        hubsTextarea.disabled=true;
        preview(hubs,"CSV");
      } else {
        hubs=hubsTextarea.value.split(/\r?\n/).filter(Boolean).map((l,i)=>{
          const p=l.split(",").map(x=>x.trim());
          if(p.length<2) throw `Manual entry error line ${i+1}`;
          return {name:p[0],postcode:norm(p[1])};
        });
        preview(hubs,"Manual");
      }

      if(!centrePc||!hubs.length) throw "Missing centre or hubs";

      const centreRes = await fetch(`https://api.postcodes.io/postcodes/${centrePc}`).then(r=>r.json());
      const c=centreRes.result;
      const hubRes = await fetch("https://api.postcodes.io/postcodes",{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({postcodes:hubs.map(h=>h.postcode)})
      }).then(r=>r.json());

      const cLL=[c.latitude,c.longitude];
      L.marker(cLL).addTo(layerGroup).bindTooltip(centreName).bindPopup(`<strong>${centreName}</strong>`);
      radiusCircle=L.circle(cLL,{radius:radiusKm*1000,fill:false}).addTo(map);

      let inside=0,outside=0,bounds=[cLL];

      hubRes.result.forEach((r,i)=>{
        if(!r.result) return;
        const h=r.result,meta=hubs[i];
        const d=distanceKm(c.latitude,c.longitude,h.latitude,h.longitude);
        const ll=[h.latitude,h.longitude];
        bounds.push(ll);
        const inRad=d<=radiusKm;
        inRad?inside++:outside++;
        exportRows.push([meta.name,meta.postcode,d.toFixed(2),inRad?"yes":"no"].join(","));
        L.marker(ll,{icon:HUB_ICON}).addTo(layerGroup)
          .bindTooltip(meta.name,{sticky:true})
          .bindPopup(`<strong>${meta.name}</strong>`);
      });

      map.fitBounds(bounds,{padding:[30,30]});
      inCount.textContent=inside;
      outCount.textContent=outside;
      totalCount.textContent=inside+outside;
      exportBtn.style.display="block";

    } catch(e){
      err.textContent=e;
    }
  }

  exportBtn.onclick=()=>{
    const csv=["name,postcode,distance_km,inside_radius",...exportRows].join("\n");
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download="hub-radius-results.csv";
    a.click();
  };

  const dz=document.getElementById("dropzone");
  dz.ondragover=e=>{e.preventDefault();dz.classList.add("dragover");};
  dz.ondragleave=()=>dz.classList.remove("dragover");
  dz.ondrop=e=>{
    e.preventDefault();dz.classList.remove("dragover");
    hubFile.files=e.dataTransfer.files;
    csvStatus.textContent=`Using CSV: ${hubFile.files[0].name}`;
    hubsTextarea.disabled=true;
  };
</script>
</body>
</html>
