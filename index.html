<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Inclusion Hubs â€“ Postcode Mapper (UK)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
    }
    .wrap {
      display: flex;
      flex-direction: row;
      height: 100vh;
    }
    .panel {
      width: 360px;
      padding: 16px;
      overflow-y: auto;
      border-right: 1px solid #e6e6e6;
      background: #fafafa;
    }
    h1 { font-size: 16px; margin-bottom: 12px; }
    label { font-size: 12px; color: #444; display: block; margin: 10px 0 4px; }
    input, textarea, button {
      width: 100%;
      font-size: 14px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea { min-height: 140px; }
    button {
      margin-top: 12px;
      background: #111;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      touch-action: manipulation;
    }
    #map { flex: 1; }
    .stats { font-size: 13px; margin-top: 12px; }
    .error { color: #b00020; font-size: 12px; white-space: pre-wrap; margin-top: 8px; }

    /* iPad / mobile */
    @media (max-width: 900px) {
      .wrap { flex-direction: column; }
      .panel { width: 100%; border-right: none; border-bottom: 1px solid #e6e6e6; }
      #map { height: 60vh; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <h1>Digital Inclusion Hub Mapper</h1>

    <label>Central postcode</label>
    <input id="centre" placeholder="E1 6AN" autocapitalize="characters">

    <label>Hub postcodes (one per line)</label>
    <textarea id="hubs" autocapitalize="characters"></textarea>

    <label>Radius (km)</label>
    <input id="radius" type="number" value="5" step="0.1">

    <!-- IMPORTANT: explicit type + inline handler for iOS -->
    <button type="button" onclick="run()">Map hubs</button>

    <div class="stats">
      Inside radius: <span id="inCount">0</span><br>
      Outside radius: <span id="outCount">0</span><br>
      Total mapped: <span id="totalCount">0</span>
    </div>

    <div class="error" id="err"></div>
  </div>

  <div id="map"></div>
</div>

<script>
  const map = L.map("map").setView([51.5074, -0.1278], 11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const layerGroup = L.layerGroup().addTo(map);
  let radiusCircle;

  function norm(pc) {
    return pc.trim().toUpperCase().replace(/\s+/g, "");
  }

  const HUB_ICON = L.icon({
  iconUrl: "./gtf-logo.png",
  iconSize: [12, 12],      // tweak size here
  iconAnchor: [8, 8],      // half of iconSize keeps it centred
  popupAnchor: [0, -8]
});

  function distanceKm(aLat, aLon, bLat, bLon) {
    const R = 6371;
    const dLat = (bLat - aLat) * Math.PI / 180;
    const dLon = (bLon - aLon) * Math.PI / 180;
    const lat1 = aLat * Math.PI / 180;
    const lat2 = bLat * Math.PI / 180;
    const h =
      Math.sin(dLat/2)**2 +
      Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.sqrt(h));
  }

  async function geocodeSingle(pc) {
    const r = await fetch("https://api.postcodes.io/postcodes/" + pc);
    const j = await r.json();
    if (!j.result) throw new Error("Invalid centre postcode");
    return j.result;
  }

  async function geocodeBulk(list) {
    const r = await fetch("https://api.postcodes.io/postcodes", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({postcodes:list})
    });
    const j = await r.json();
    return j.result.filter(x => x.result).map(x => x.result);
  }

  async function run() {
    document.getElementById("err").textContent = "";
    layerGroup.clearLayers();
    if (radiusCircle) map.removeLayer(radiusCircle);

    try {
      const centrePc = norm(document.getElementById("centre").value);
      const hubLines = document.getElementById("hubs").value
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(Boolean);

      const hubs = hubLines.map(line => {
      const parts = line.split("|").map(p => p.trim());
      const postcode = norm(parts[0] || "");
      const name = parts[1] || postcode; // fallback: show postcode if no name given
      return { postcode, name };
    }).filter(h => h.postcode);

      const radiusKm = Number(document.getElementById("radius").value);

      if (!centrePc || !hubs.length) throw new Error("Enter centre + at least one hub postcode.");

      const centre = await geocodeSingle(centrePc);
      const hubResults = await geocodeBulk(hubs.map(h => h.postcode));

      const cLatLng = [centre.latitude, centre.longitude];
      L.marker(cLatLng).addTo(layerGroup).bindPopup("Centre").openPopup();

      radiusCircle = L.circle(cLatLng, {radius: radiusKm*1000, fill: false}).addTo(map);

      let inside = 0, outside = 0;
      const bounds = [cLatLng];

    hubResults.forEach((h, i) => {
      const hubMeta = hubs[i]; // same order as bulk request
      const d = distanceKm(centre.latitude, centre.longitude, h.latitude, h.longitude);
      const ll = [h.latitude, h.longitude];
      bounds.push(ll);

      if (d <= radiusKm) inside++; else outside++;
    
      const marker = L.marker(ll, { icon: HUB_ICON }).addTo(layerGroup);
    
      // Hover label (works on desktop; on iPad it shows on tap)
      marker.bindTooltip(hubMeta?.name || hubMeta?.postcode || "Hub", {
        direction: "top",
        offset: [0, -6],
        opacity: 0.95,
        sticky: true
      });

  // Optional: click popup shows more detail
  marker.bindPopup(
    `<strong>${hubMeta?.name || "Hub"}</strong><br>${hubMeta?.postcode || ""}<br>${d.toFixed(2)} km`
  );
});


      map.fitBounds(bounds, {padding:[30,30]});

      document.getElementById("inCount").textContent = inside;
      document.getElementById("outCount").textContent = outside;
      document.getElementById("totalCount").textContent = hubResults.length;

    } catch (e) {
      document.getElementById("err").textContent = e.message;
    }
  }
</script>
</body>
</html>
